<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migra√ß√£o de Dados - Manuten√ß√£o Industrial</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    #log {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Migra√ß√£o de Dados</h1>
    <p>Esta ferramenta ir√° copiar as ordens de servi√ßo do localStorage para o banco de dados MySQL.</p>
    
    <div class="info">
      <strong>Instru√ß√µes:</strong><br>
      1. Clique em "Verificar Dados" para ver quantas ordens existem<br>
      2. Clique em "Enviar para Banco" para migrar os dados<br>
      3. O aplicativo deve estar rodando (docker-compose up)
    </div>
    
    <div>
      <button onclick="checkData()">üîç Verificar Dados</button>
      <button onclick="migrateData()" id="migrateBtn" disabled>üì§ Enviar para Banco</button>
      <button onclick="clearStorage()" id="clearBtn" disabled>üóëÔ∏è Limpar localStorage</button>
    </div>
    
    <div id="result"></div>
    <div id="log"></div>
  </div>

  <script>
    const API_URL = 'http://localhost:3001/api/orders';
    let ordersToMigrate = [];

    function log(message) {
      document.getElementById('log').textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
    }

    async function checkData() {
      // Primeiro, tenta buscar do localStorage local
      let data = localStorage.getItem('industrial_maintenance_orders');
      
      if (!data) {
        // Se n√£o encontrou, tenta buscar do localStorage do app Docker
        log('Buscando dados do localStorage do aplicativo Docker...');
        try {
          const response = await fetch('http://localhost:8080');
          // O localStorage do Docker n√£o pode ser acessado diretamente
          // Vamos verificar a API
        } catch (e) {
          log('N√£o foi poss√≠vel acessar o app Docker diretamente');
        }
      }
      
      if (!data) {
        // Verificar se h√° dados no banco via API
        try {
          const response = await fetch('http://localhost:3001/api/orders');
          if (response.ok) {
            const existingOrders = await response.json();
            if (existingOrders.length > 0) {
              document.getElementById('result').innerHTML = `
                <div class="success">
                  ‚úÖ O banco de dados j√° cont√©m <strong>${existingOrders.length}</strong> ordens de servi√ßo!
                </div>
              `;
              log(`Banco de dados j√° tem ${existingOrders.length} ordens`);
              document.getElementById('migrateBtn').disabled = true;
              return;
            }
          }
        } catch (e) {
          log('Erro ao verificar API: ' + e.message);
        }
        
        document.getElementById('result').innerHTML = `
          <div class="error">
            Nenhum dado encontrado!<br><br>
            <strong>Poss√≠veis causas:</strong><br>
            1. Voc√™ ainda n√£o criou nenhuma ordem de servi√ßo no aplicativo<br>
            2. Os dados est√£o no localStorage do app Docker (http://localhost:8080)<br>
            <br>
            <strong>Solu√ß√£o:</strong><br>
            Abra o aplicativo em <a href="http://localhost:8080" target="_blank">http://localhost:8080</a>,<br>
            crie algumas ordens de servi√ßo, e tente novamente.
          </div>
        `;
        return;
      }
      
      ordersToMigrate = JSON.parse(data);
      document.getElementById('result').innerHTML = `
        <div class="success">
          ‚úÖ Encontradas <strong>${ordersToMigrate.length}</strong> ordens de servi√ßo no localStorage!
        </div>
      `;
      document.getElementById('migrateBtn').disabled = false;
      document.getElementById('clearBtn').disabled = false;
      log(`Encontradas ${ordersToMigrate.length} ordens para migrar`);
    }

    async function migrateData() {
      if (ordersToMigrate.length === 0) {
        document.getElementById('result').innerHTML = '<div class="error">Nenhuma ordem para migrar!</div>';
        return;
      }

      const migrateBtn = document.getElementById('migrateBtn');
      migrateBtn.disabled = true;
      migrateBtn.textContent = '‚è≥ Enviando...';
      
      let successCount = 0;
      let errorCount = 0;

      for (const order of ordersToMigrate) {
        try {
          log(`Enviando OS: ${order.id} - ${order.requester}`);
          
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requester: order.requester,
              tag: order.tag,
              equipmentName: order.equipmentName,
              sector: order.sector,
              maintenanceType: order.maintenanceType,
              problemDescription: order.problemDescription
            })
          });

          if (response.ok) {
            successCount++;
            log(`‚úÖ OS ${order.id} migrada com sucesso!`);
          } else {
            errorCount++;
            log(`‚ùå Erro ao migrar OS ${order.id}: ${response.statusText}`);
          }
        } catch (error) {
          errorCount++;
          log(`‚ùå Erro: ${error.message}`);
        }
      }

      document.getElementById('result').innerHTML = `
        <div class="success">
          üéâ Migra√ß√£o conclu√≠da!<br>
          ‚úÖ Sucesso: ${successCount}<br>
          ‚ùå Erros: ${errorCount}
        </div>
      `;
      
      migrateBtn.textContent = '‚úÖ Conclu√≠do!';
      log(`Migra√ß√£o finalizada: ${successCount} sucesso, ${errorCount} erros`);
    }

    function clearStorage() {
      if (confirm('Tem certeza que deseja limpar o localStorage? Esta a√ß√£o n√£o pode ser desfeita.')) {
        localStorage.removeItem('industrial_maintenance_orders');
        ordersToMigrate = [];
        document.getElementById('result').innerHTML = '<div class="success">‚úÖ localStorage limpo com sucesso!</div>';
        document.getElementById('migrateBtn').disabled = true;
        document.getElementById('clearBtn').disabled = true;
        log('localStorage limpo');
      }
    }
  </script>
</body>
</html>
